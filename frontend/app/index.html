<!DOCTYPE html>
<html>
<head>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.0.3/socket.io.js"></script>
	<meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
	<script src="http://d3js.org/d3.v3.min.js"></script>
	<script type="text/javascript" src="js/d3.geo.js"></script>
	<script type="text/javascript" src="js/main.js"></script>
	<script type="text/javascript" src="js/jquery.min.js"></script>
	<link type="text/css" rel="stylesheet" href="css/main.css"/>
	<!--<link type="text/css" rel="stylesheet" href="css/style.css"/>-->
	<link type="text/css" rel="stylesheet" href="css/colorbrewer.css"/>
	<style type="text/css">

		svg {
			width: 800px;
			 height: 800px;
			pointer-events: all;
		}

		circle {
			fill: #dbe4f0;
		}

		path {
			fill: #aaa;
			stroke: #fff;
		}


		h1 {
			font-family:arial;
			font-size:2em;
			color:#ffffff;
		}

		#info {
			position:absolute;
			top: 10px;
			left: 10px;
		}

		.states {
			fill: #e5e5e5;
			stroke: #fff;
			stroke-width:1px;
		}

		.states:hover {
			fill: steelblue;
		}


	</style>
</head>
<body>

<div id="body">
	<div id="info"><span id="name"></span></div>
	<div id="sidebar"> 
		<div class="tagcloud">   
			<div id="cloudChart">
			</div>
		</div>
		 
		<div class="newsfeed">

		</div>
		 
	</div>
	<div id="footer">
		<div><select>
			<option value="equalarea">equalarea</option>
			<option value="equidistant">equidistant</option>
			<option value="gnomonic">gnomonic</option>
			<option value="orthographic" selected>orthographic</option>
			<option value="stereographic">stereographic</option>
		</select></div>
	</div>
</div>

<script src='js/crossfilter.js' type='text/javascript'></script>
<script src='js/dc.js' type='text/javascript'></script>
<script src='js/data-processing.js' type='text/javascript'></script>
<script type="text/javascript">

    var width = window.innerWidth ;//960, //1280 
		height = window.innerHeight;//800;
	var scale = 300;
    var feature;

    var projection = d3.geo.azimuthal()
        .scale(scale)
        .origin([-71.03,42.37])
        .mode("orthographic")
        .translate([400, 350]);

    var circle = d3.geo.greatCircle()
        .origin(projection.origin());

    // TODO fix d3.geo.azimuthal to be consistent with scale
    var scale = {
        orthographic: scale,
        stereographic: scale,
        gnomonic: scale,
        equidistant: scale / Math.PI * 2,
        equalarea: scale / Math.SQRT2
    };

    var path = d3.geo.path()
        .projection(projection);

    var svg = d3.select("#body").append("svg:svg")
        .attr("width", width)
        .attr("height", height)
        .on("mousedown", mousedown);


    d3.json("json/world-countries.json", function(collection) {
        feature = svg.selectAll("path")
            .data(collection.features)
            .enter()
            .append("svg:path")
            .attr('class', 'states')
            .attr("id", stateId)
			.attr("d", clip)
            .on('mouseover', function(d){
                var name = d.properties.name;
                return document.getElementById('name').innerHTML=name;
            });


        feature.append("svg:title")
            .text(function(d) { return d.properties.name; });

        d3.json("json/input.json", function(newscollection) {

            $.each(newscollection, function(){
                var feature = $('#state-'+this.geography);
                if(this.score < 0.4){
                    feature.attr('class', 'states negative');
                } else if (this.score >= 0.4 && this.score < 0.6){
                    feature.attr('class', 'states neutral');
                } else if(this.score >= 0.6){
                    feature.attr('class', 'states positive');
                }
            });
        });

    });





    d3.select(window)
        .on("mousemove", mousemove)
        .on("mouseup", mouseup);

    d3.select("select").on("change", function() {
        projection.mode(this.value).scale(scale[this.value]);
        refresh(750);
    });

    var m0,
        o0;

    function mousedown() {
        m0 = [d3.event.pageX, d3.event.pageY];
        o0 = projection.origin();
        d3.event.preventDefault();
    }

    function mousemove() {
        if (m0) {
            var m1 = [d3.event.pageX, d3.event.pageY],
                o1 = [o0[0] + (m0[0] - m1[0]) / 8, o0[1] + (m1[1] - m0[1]) / 8];
            projection.origin(o1);
            circle.origin(o1)
            refresh();
        }
    }

    function mouseup() {
        if (m0) {
            mousemove();
            m0 = null;
        }
    }

    function refresh(duration) {
        (duration ? feature.transition().duration(duration) : feature).attr("d", clip);
    }

    function clip(d) {
        return path(circle.clip(d));
    }
    function stateId(d) {
        return "state-"+d.id;
	}


//    if(document.querySelector('.'+user.state)) {
//        tally[user.state] = (tally[user.state] || {positive: 0, negative: 0});
//        tally[user.state][emotion.type] = (tally[user.state][emotion.type] || 0) + 1;
//
//        var stateEl = document.querySelector('.'+user.state);
//        stateEl.style.fill = (tally[user.state].positive > tally[user.state].negative) ? positiveColor : ((tally[user.state].positive < tally[user.state].negative) ? negativeColor :neutralColor);
//
//        stateEl.setAttribute('data-positive', tally[user.state].positive);
//        stateEl.setAttribute('data-negative', tally[user.state].negative);
//    }

</script>

<script type="text/javascript" src="js/d3.layout.cloud.js"></script>
<script type="text/javascript" src="js/dc-wordcloud.js"></script>
<script type="text/javascript">
    var data = 'json/input.json';
</script>
<script type="text/javascript" src="js/tagcloud.js"></script>

</body>
</html>
